---
title: "Production Preprocess"
author: "Xinyu Zhang"
date: "2023-03-27"
output: html_document
---

### Measurements from genders and phonemes
```{r echo=TRUE}
library(dplyr)
fi<- read.csv("allFemaleI.csv", header = TRUE, sep = "\t")
fig<- fi |> mutate(gender = c(rep("F", times = nrow(fi))))
  
fe <- read.csv("allFemaleE.csv", header = TRUE, sep = "\t")
feg<- fe |> mutate(gender = c(rep("F", times = nrow(fe))))

mi<- read.csv("allMaleI.csv", header = TRUE, sep = "\t")
  mig<- mi |> mutate(gender = c(rep("M", times = nrow(mi))))

me <- read.csv("allMaleE.csv", header = TRUE, sep = "\t")
meg<- me |> mutate(gender = c(rep("M", times = nrow(me))))

mfie<- rbind(fig, feg, mig, meg)

#extract the fileName column
#fileNames<- rcds |> select(fileName)
#head(fileNames)
```

### splitting the different segments in the file name into columns because they provide info about the recording

```{r}
prod <- read.table(text = as.character(mfie$fileName), sep = "_")
head(prod)

### removing the ".wav" from the final column
#```{r}
#library(stringr)
#library(dplyr)
#prod <- prod %>% 
#  mutate(V5 =
#   str_sub(prod$V5, end=-5)
#  )
#head(prod)
```


### renaming the column names accordingly
```{r}
#removing column 1 because it's just "subj"
newcols <- prod %>% 
  select(-V1)
colnames(newcols)

#revert the "Post" and the "seq" for posttest items 
#if v5 = post, v5 = v4, v4 = v5
correctPost <- newcols |> 
  mutate(V51 = ifelse(V5 == "Post", V4, V5),
         V4 = ifelse(V5 == "Post", V5, V4)) |> 
  select(-V5) |> 
  rename("V5" = "V51")

head(correctPost)

#rename new columns accordingly
nc<- correctPost %>% 
  rename("subj" = "V2",
         "word" = "V3",
         "block" = "V4",
         "seq" = "V5")

head(nc)


allcol<- as.data.frame(cbind(mfie$fileName, nc))|> rename("fileName"="mfie$fileName")
colnames(allcol)

df <- full_join(allcol, mfie, by = "fileName") |> rename("F0Hz" = "F0.Hz.", "F1Hz" = "F1.Hz.", "F2Hz" = "F2.Hz.", "F1Bark" = "F1.Bark.", "F2Bark" = "F2.Bark.")

#add column about BB condition

d <- df |> 
   mutate(
    BB = case_when(
      subj == "2" ~ "BB",
      subj == "4" ~ "BB",
      subj == "5" ~ "BB",
      subj == "9" ~ "BB",
      subj == "10" ~ "BB",
      subj == "12" ~ "BB",
      subj == "13" ~ "BB",
      subj == "14" ~ "BB",
      subj == "15" ~ "BB",
      subj == "16" ~ "BB",
      subj == "17" ~ "BB",
      subj == "19" ~ "BB",
      subj == "22" ~ "BB",
      subj == "25" ~ "BB",
      subj == "28" ~ "BB",
      subj == "32" ~ "BB",
      subj == "33" ~ "BB",
      subj == "34" ~ "BB",
      subj == "37" ~ "BB",
      subj == "39" ~ "BB",
      subj == "41" ~ "BB",
      subj == "42" ~ "BB",
      subj == "44" ~ "BB",
      subj == "45" ~ "BB",
      subj == "48" ~ "BB",
      subj == "52" ~ "BB",
      subj == "53" ~ "BB",
      subj == "55" ~ "BB",
      subj == "58" ~ "BB",
      subj == "59" ~ "BB",
      subj == "60" ~ "BB",
      TRUE ~ "NB")
   )

```

### plotting

```{r}
library(ggplot2)
library(patchwork)
#NB group pre and post for I
nbprei<- d |> filter(BB == "NB", block == "Pre", Label == "I")
nbposti <- d |> filter(BB == "NB", block == "Post", Label == "I")
nbi <- rbind(nbprei, nbposti)

ggplot(data = nbi, aes(x = F2Hz, y = F1Hz, color = block))+
  geom_point(alpha = 0.5) + xlim(1200, 3250) + ylim(100, 1750)

#NB group pre and post for E
nbpree<- d |> filter(BB == "NB", block == "Pre", Label == "E")
nbposte <- d |> filter(BB == "NB", block == "Post", Label == "E")
nbe <- rbind(nbpree, nbposte)

ggplot(data = nbe, aes(x = F2Hz, y = F1Hz, color = block))+
  geom_point(alpha = 0.8) + xlim(1200, 3250) + ylim(100, 1750)

#I and E together
nbpre<- d |> filter(BB == "NB", block == "Pre")
nbpost <- d |> filter(BB == "NB", block == "Post")
nb <- rbind(nbpre, nbpost)

ggplot(data = nb, aes(x = F2Hz, y = F1Hz, color = block, shape = Label))+
  geom_point(alpha = 0.7) +xlim(1200, 3250) + ylim(100, 1750)

pi<- ggplot(data = nbi, aes(x = F2Hz, y = F1Hz, color = block))+
  geom_point(alpha = 0.5) +xlim(1200, 3250) + ylim(100, 1750) + labs(title = "pre vs post /I/")

pe<-ggplot(data = nbe, aes(x = F2Hz, y = F1Hz, color = block))+
  geom_point(alpha = 0.8) +xlim(1200, 3250) + ylim(100, 1750)+ labs(title = "pre vs post /E/")
pi / pe
```

```{r}
library(patchwork)
#BB group pre and post
bbpre<- d |> filter(BB == "BB", block == "Pre") #, Label == "E")
bbpost <- d |> filter(BB == "BB", block == "Post") #,Label == "E")
bb <- rbind(bbpre, bbpost)

#contrast at pretest for BB group
p1 <- ggplot(data = bbpre, aes(x = F2Hz, y = F1Hz, color = Label))+
  geom_point(alpha = 0.5) + xlim(1200,3000) + ylim(100, 1500)+labs(title = "pre")

#contrast at posttest for BB group
p2 <- ggplot(data = bbpost, aes(x = F2Hz, y = F1Hz, color = Label))+
  geom_point(alpha = 0.5) + xlim(1200,3000) + ylim(100, 1500) + labs(title = "post")

p1 + p2
```


counting subjects
```{r}
d |> count(subj)
```



### coding in the block names correctly

E.g., if the participant went through the sequence of AF -> MN, then assign AF1, MN2 to the AF and MN blocks; if the participant went through the sequence of MN -> AF, then assign MN1, AF2 to the AF and MN blocks. Also coding in the bite block condition, since ultimately the analysis is comparing four groups.
```{r}

#define a function
#correctBlocks <- function(n) {

mn2subj <- c("2", "3", "5", "6", "8", "9", "10", "12", "15", "17", "19", "26", "30", "31", "33", "35", "38", "40", "42", "43", "46", "48", "50", "51", "52", "53", "54", "56", "58", "60")

db <-  d |> 
  mutate(
    block = case_when(
      subj %in% mn2subj & block == "MN1" ~ "MN2",
      subj %in% mn2subj & block == "AF2" ~ "AF1",
      subj %in% mn2subj & block == "Pre" ~ "Pre",
      subj %in% mn2subj & block == "Post" ~ "Post",
      !(subj %in% mn2subj) & block == "MN1" ~ "MN1",
      !(subj %in% mn2subj) & block == "AF2" ~ "AF2",
      !(subj %in% mn2subj) & block == "Pre" ~ "Pre",
      !(subj %in% mn2subj) & block == "Post" ~ "Post"
    )
    )
#}
```



```{r}
#check if all subjects are coded correctly

db |> filter(block == "MN2") |> count(subj)
```

```{r}
library(ggplot2)
# /E/ in BB group pretest and test
bbprentest<- db |> filter(BB == "BB", Label == "E") |> filter(block == "Pre" | block == "AF1" | block == "MN1" | block == "Post")
#nrow(bbprentest)

ggplot(data = bbprentest, aes(x = F2Hz, y = F1Hz, color = block))+
  geom_point(alpha = 0.5)

# /I/ in BB group pretest and test
bbprentest<- db |> filter(BB == "BB", Label == "I") |> filter(block == "Pre" | block == "AF1" | block == "MN1" | block == "Post")
#nrow(bbprentest)

ggplot(data = bbprentest, aes(x = F2Hz, y = F1Hz, color = block))+
  geom_point(alpha = 0.5)
```


```{r}
#BB group, pre vs post, both phonemes
library(patchwork)
bbprentestE<- db |> filter(BB == "BB", Label == "E") |> filter(block == "Pre" | block == "Post")
bbprentestI<- db |> filter(BB == "BB", Label == "I") |> filter(block == "Pre" | block == "Post")
#nrow(bbprentest)

p1 <- ggplot(data = bbprentestE, aes(x = F2Hz, y = F1Hz, color = block))+
  geom_point(alpha = 0.5) + ggtitle("pre/post comparison of /E/")+theme(legend.position="none")

p2 <- ggplot(data = bbprentestI, aes(x = F2Hz, y = F1Hz, color = block))+
  geom_point(alpha = 0.5)+ ggtitle("pre/post comparison of /I/")

p1 + p2 
```

linear regression (all blocks):
```{r}
#blocks: pre, AF1, MN1, Post

library(lme4)

af1subj <- c("2", "3", "5", "6", "8", "9", "10", "12", "15", "17", "19", "26", "30", "31", "33", "35", "38", "40", "42", "43", "46", "48", "50", "51", "52", "53", "54", "56", "58", "60")

df <- db |> filter(block == "Pre" | block == "AF1" | block == "MN1" | block == "Post") |> 
  mutate(
    AF = case_when(
      subj %in% af1subj ~ "AF",
      TRUE ~ "MN")) |> mutate(
     block = case_when(
      block == "AF1" ~ "2",
      block == "MN1" ~ "2",
      block == "Pre" ~ "1",
      block == "Post" ~ "4")
   )

#change variables into correct data types
df$BB <- as.factor(df$BB)
df$Label <- as.factor(df$Label)
df$block <- as.factor(df$block)
df$gender <- as.factor(df$gender)
df$AF <- as.factor(df$AF)
df$subj <- as.character(df$subj)
df$seq <- as.numeric(df$seq)
df$F0Hz <- as.numeric(df$F0Hz)
df$F1Hz <- as.numeric(df$F1Hz)
df$F2Hz <- as.numeric(df$F2Hz)
df$F1Bark <- as.numeric(df$F1Bark)
df$F2Bark <- as.numeric(df$F2Bark)

write.csv(df, "productionFullTable.csv")

#contrast coding
df$BB <- relevel(df$BB, ref = "NB")

df$Label <- relevel(df$Label, ref = "I")

df$block <- relevel(df$block, ref = "1")

df$gender <- relevel(df$gender, ref = "F")

#model with blocks 1,2,4
f1hzallbl <- lmer(F1Hz ~ block * BB * AF* Label + gender + (1|subj) + (1|word), data = df)
summary(f1hzallbl)
```
Interpretations:

Estimate Std. Error t value                        
                        
block2                    0.6292     9.7768   0.064 in the NB group,  F1 in /I/ at test did not differ from pretest, for female speakers

block4                   14.8829     9.7121   1.532 in the NB group, F1 in /I/ at posttest did not differ from pretest, for female speakers

BBBB                      9.2792    23.1196   0.401 the F1 in /I/ in BB group did not differ from the NB group at pretest, for female speakers

AFMN                    -18.6968    24.1381  -0.775 the F1 in /I/ in the MN group did not differ from the AF group at pretest, for female speakers

LabelE                  147.4586    13.5919  10.849 **the F1 for  /E/ in the NB group is 147.4586 Hz higher than /I/ at pretest, for female speakers**

genderM                 -96.9882    21.2561  -4.563 **at pretest, male speakers have an F1 in /I/ that is 96.9882 Hz lower than that of female speakers**

block2:BBBB              36.7918    13.3972   2.746 **the F1 increase in /I/ from pretest to test is 36.7918 Hz higher in the BB group than in the NB and AF group, for female speakers**

block4:BBBB             -24.5214    13.3629  -1.835 the difference in F1 from pretest to posttest did not differ between BB and NB group (female speakers)

block2:AFMN              63.0118    13.8559   4.548 **from pretest to test, the F1 in /I/ in the NBMN group increased 63.0118 Hz more than the NBAF group (f speakers)**

block4:AFMN             -28.1106    13.7801  -2.040 **at posttest the F1 in /I/ in the MN group is 28.11 Hz lower than at pretest**

BBBB:AFMN                -9.7971    33.2636  -0.295 the F1 in /I/ did not differ between BBAF and BBMN group at pretest

block2:LabelE            -8.1994    13.8630  -0.591 the F1 difference between /I/ and /E/ is not bigger in the NB group when comparing test to pretest

block4:LabelE           -18.4500    13.8138  -1.336 the difference in F1 between /I/ and /E/ did not change from pre to posttest for the NB group

BBBB:LabelE             -20.8307    13.4341  -1.551 the difference in F1 between /I/ and /E/ did not differ between BB and NB group at pretest

AFMN:LabelE              39.3578    13.8591   2.840 **the difference in F1 between /I/ and /E/ is 39 Hz bigger in the NBMN group than in the NBAF group at pretest**

block2:BBBB:AFMN        -23.3488    19.3244  -1.208 when comparing test to pretest, the AF/MN did not affect the effect that BB has on the F1 of /I/

block4:BBBB:AFMN         36.4373    19.2392   1.894 when comparing posttest to pretest, the AF/MN did not affect the effect that BB has on the F1 of /I/

block2:BBBB:LabelE       -9.4693    18.9657  -0.499 when comparing test to pretest, BB did not affect the difference between /I/ and /E/ in the AF group

block4:BBBB:LabelE       30.9208    18.9483   1.632 when comparing posttest to pretest, BB did not affect the difference between /I/ and /E/ in the AF group

block2:AFMN:LabelE       35.7435    19.5786   1.826 when comparing test to pretest, MN did not affect the difference between /I/ and /E/ in the NB group

block4:AFMN:LabelE       27.4315    19.5549   1.403 when comparing posttest to pretest, MN did not affect the difference between /I/ and /E/ in the NB group

BBBB:AFMN:LabelE        -23.8587    19.2555  -1.239 at pretest, the difference between /I/ and /E/ caused by being in the BB group (not significant) was not modulated by being assigned in the MN group

block2:BBBB:AFMN:LabelE -29.3712    27.2894  -1.076 when comparing test to pretest, the effect of BB on the /I/-/E/ contrast (not significant, see block2:BBBB:LabelE) was not modulated by the MN

block4:BBBB:AFMN:LabelE -36.1044    27.2431  -1.325 when comparing posttest to pretest, the effect of BB on the /I/-/E/ contrast (not significant, see block4:BBBB:LabelE) was not modulated by the MN

```{r}
#effect plots
library (effects)
 eall.f1hzallbl <- predictorEffects(f1hzallbl)
 #plot(eall.f1hzallbl)
 #plot(predictorEffects(f1hzallbl, ~BB))
 #plot(predictorEffects(f1hzallbl, ~block))
 plot(predictorEffects(f1hzallbl, ~Label))
```






```{r}
# BB group, pre vs test, both phonemes

bbprentestE<- df |> filter(BB == "BB", Label == "E") |> filter(block == "1" | block == "2") |> mutate(block = case_when(block == "1" ~ "pretest",
                        block == "2" ~ "test"))
bbprentestI<- df |> filter(BB == "BB", Label == "I") |> filter(block == "1" | block == "2")|> mutate(block = case_when(block == "1" ~ "pretest",
                        block == "2" ~ "test"))
#nrow(bbprentest)

p1 <- ggplot(data = bbprentestE, aes(x = F2Hz, y = F1Hz, color = block))+
  geom_point(alpha = 0.5) + ylim (200, 1500) + ggtitle("bite block effect for /E/")+theme(legend.position="none")

p2 <- ggplot(data = bbprentestI, aes(x = F2Hz, y = F1Hz, color = block))+
  geom_point(alpha = 0.5) + ylim (200, 1500) + ggtitle("bite block effect for /I/")

p1 + p2 
```
#### similar model on F2

```{r}
f2hzallbl <- lmer(F2Hz ~ block * BB * AF* Label + gender + (1|subj) + (1|word), data = df)
summary(f2hzallbl)
```
Significant results:

                        Estimate Std. Error t value
                        
block4                   -56.774     17.351  -3.272   in the NB group, F2 in /I/ at posttest is 56.774 Hz lower than pretest, for female speakers                   
                        
LabelE                  -255.947     83.267  -3.074 at pretest female speakers' F2 in /E/ is 255.947 Hz lower than their F2 in /I/ 

genderM                 -239.801     40.375  -5.939 at pretest female speakers' F2 in /I/ 239.801 Hz lower than the females speakers

block2:BBBB             -651.743     23.935 -27.230 the change of F2 in /I/ from pretest to test is 651.743 Hz smaller in the BB group when compared to BB group (which did not change) ==> the F2 in BB group decreased 651.743 Hz at test when compared to pretest (for female speakers)
                        
block4:BBBB             -24.5214    13.3629  -1.835 the difference in F1 from pretest to posttest did not differ between BB and NB group (female speakers)

block4:BBBB               28.908     23.874   1.211 the change in F2 in /I/ from pretest to posttest (sig. in NB group) is not modulated by being in the BB group (having BB did not change the "base" effect) (for female speakers)

block2:AFMN              -54.598     24.754  -2.206 the change in F2 in /I/ for the NB group from pretest to test (not sig.) isn ot modualted by MN (for female speakers)

block4:AFMN               46.824     24.619   1.902 the change in F2 in /I/ for the NB from pretest to posttest (sig.) is not modulated by MN (having MN did not change the "base" effect) (for female speakers)

BBBB:LabelE               65.757     24.001   2.740 the F2 difference between /I/ and /E/ is 65.757 Hz higher in the BB group than the NB group at pretest (for female speakers)

block2:BBBB:AFMN         -85.069     34.524  -2.464 having MN decreased the F2 shift from test to pretest in the BB group (sig.) for 85.069 Hz (for female speakers)

block2:BBBB:LabelE       190.195     33.883   5.613 when comparing test to pretest, BB increased the F2 difference between /I/ and /E/ in the AF group (sig.) for 190.195 Hz (for female speakers)

block4:BBBB:LabelE       -38.486     33.852  -1.137 when comparing posttest to pretest, having had the BB did not affect the F2 difference between /I/ and /E/ in the AF group (not sig.)(for female speakers).

block2:AFMN:LabelE        36.238     34.978   1.036 MN did not affect the /I/-/E/ contrast in F2 in the NB group at test (for female speakers)

block4:AFMN:LabelE       -33.284     34.936  -0.953 MN did not affect the /I/-/E/ contrast in F2 in the NB group at posttest (for female speakers)

block2:BBBB:AFMN:LabelE    8.991     48.754   0.184 MN did not affect the effect that BB has on the /I/-/E/ contrast in F2 at test (for female speakers)
block4:BBBB:AFMN:LabelE   25.526     48.672   0.524 MN did not affect the effect that BB has on the /I/-/E/ contrast in F2 at posttest (for female speakers)

#### model including sequence number as a variable

```{r}
#convert seq as numeric instead of categorical
df$seq <- as.numeric(df$seq)
```

```{r}
#seq as a separate variable
f1hzallblsq1 <- lmer(F1Hz ~ block * BB * AF* Label +  seq + gender + (1|subj) + (1|word), data = df)
summary(f1hzallblsq1)
```
`seq` itself is not significant.

```{r}
#seq as interaction in hertz model
f1hzallblsq <- lmer(F1Hz ~ block * BB * AF* Label * seq + gender + (1|subj) + (1|word), data = df)
summary(f1hzallblsq)
```
`seq` itself is not significant. The only significant interaction is `block4:LabelE:seq`. Interpretation: the difference of the /I/-/E/ contrast between block 2 and block 4 (diff of diff) is modified by the sequence. As sequence increase 1, the contrast decreases by 2.85 Hz. But since the intercept is on the NB group. This is only about the group without bite blocks. `block4:BBBB:LabelE:seq` is not significant.

```{r}
#try releveling the reference level to BB to check if block4:LabelE:seq is significant
df$BB <- relevel(df$BB, ref = "BB")
f1hzallblsqrl <- lmer(F1Hz ~ block * BB * AF* Label * seq + gender + (1|subj) + (1|word), data = df)
summary(f1hzallblsqrl)
```

Not.


```{r}
#bark model with seq
#correct back to NB as reference
df$BB <- relevel(df$BB, ref = "NB")

f1bkallblsq <- lmer(F1Bark ~ block * BB * AF* Label * seq + gender + (1|subj) + (1|word), data = df)
summary(f1bkallblsq)
```

Nothing involving `seq` is significant in the bark model.

```{r}
#F2 model in bark
f2hzallblsq <- lmer(F2Hz ~ block * BB * AF* Label * seq + gender + (1|subj) + (1|word), data = df)
summary(f2hzallblsq)
```

Nothing involving `seq` is significant.


```{r}
#F2 model in bark
f2bkallblsq <- lmer(F2Bark ~ block * BB * AF* Label * seq + gender + (1|subj) + (1|word), data = df)
summary(f2bkallblsq)
```

Nothing involving `seq` is significant.

#### interaction plots
```{r}
#model for pretest vs test in order to only plot the interaction effect in pre vs post
prentest <- df |> filter(block == "1" | block == "2")|> mutate(block = case_when(block == "1" ~ "pretest",
                        block == "2" ~ "test"))

f2hzprentest <- lmer(F2Hz ~ block * BB * AF* Label + gender + (1|subj) + (1|word), data = prentest)
#effect plot
library(effects)
plot(effect( "block * BB * AF", f2hzprentest))
```


```{r}
#bark model
f1barkallbl <- lmer(F1Bark ~ block * BB * AF* Label + gender + (1|subj) + (1|word), data = df)
summary(f1barkallbl)
```


```{r}
library(lme4)
f2barkallbl <- lmer(F2Bark ~ block * BB * AF* Label + gender + (1|subj) + (1|word), data = df)
summary(f2barkallbl)
```

### Ridge plots

#### ridge plots for RQ1
```{r}
#in hertz
library(ggplot2)
library(ggridges)
#define color-blindness-friendly colors
vowelcolor <- c("#0072B2", "#CC79A7")

#AF, F1
afdf <- df |> filter(AF == "AF")

ggplot(afdf, aes(x = F1Hz, y = block, fill = BB, linetype = Label)) +
  geom_density_ridges(alpha = 0.6, scale = 1.2) +
  theme_ridges() +
  #scale_fill_discrete(breaks = c ("F1Hertz","F2Hertz")) +
  scale_fill_manual(values = vowelcolor)
  #+ggtitle("F1 in two vowels between groups in each test block, with regular auditory feedback")
  
ggsave("ridgeF1BlockXBB*vowel_AF.png", plot = last_plot(), device = NULL, scale = 1,dpi = 600)

#AF, F2
ggplot(afdf, aes(x = F2Hz, y = block, fill = BB, linetype = Label)) +
  geom_density_ridges(alpha = 0.6, scale = 1.2) +
  theme_ridges() +
  #scale_fill_discrete(breaks = c ("F1Hertz","F2Hertz")) +
  scale_fill_manual(values = vowelcolor)
  #+ggtitle("formant values in two vowels between groups in each test block, with regular auditory feedback")

ggsave("ridgeF2BlockXBB*vowel_AF.png", plot = last_plot(), device = NULL, scale = 1,dpi = 600)


# MN F1
mndf <- df |> filter(AF == "MN")
ggplot(mndf, aes(x = F1Hz, y = block, fill = BB, linetype = Label)) +
  geom_density_ridges(alpha = 0.6, scale = 1.2) +
  theme_ridges() +
  #scale_fill_discrete(breaks = c ("F1Hertz","F2Hertz")) +
  scale_fill_manual(values = vowelcolor)
  #+ggtitle("formant values in two vowels between groups in each test block, with masking noise")
  
ggsave("ridgeF1BlockXBB*vowel_MN.png", plot = last_plot(), device = NULL, scale = 1,dpi = 600)

#MN F2
ggplot(mndf, aes(x = F2Hz, y = block, fill = BB, linetype = Label)) +
  geom_density_ridges(alpha = 0.6, scale = 1.2) +
  theme_ridges() +
  #scale_fill_discrete(breaks = c ("F1Hertz","F2Hertz")) +
  scale_fill_manual(values = vowelcolor)
  #+ggtitle("formant values in two vowels between groups in each test block, with masking noise")
  
ggsave("ridgeF2BlockXBB*vowel_MN.png", plot = last_plot(), device = NULL, scale = 1,dpi = 600)
```

#### ridge plots for RQ2
```{r}
#BB*AF at block 2 because that is the only significant block
#F1
ggplot(df, aes(x = F1Hz, y = AF, fill = BB, linetype = Label)) +
  geom_density_ridges(alpha = 0.6, scale = 1.2) +
  theme_ridges() +
  scale_fill_manual(values = vowelcolor)
  #+ggtitle("formant values in two vowels between groups in each test block, with masking noise")
  
ggsave("ridgeF1Block*BB_block2.png", plot = last_plot(), device = NULL, scale = 1,dpi = 600)
#hyper articulation in the MN condition because Lombard?

#F2
ggplot(df, aes(x = F2Hz, y = AF, fill = BB, linetype = Label)) +
  geom_density_ridges(alpha = 0.6, scale = 1.2) +
  theme_ridges() +
  #scale_fill_discrete(breaks = c ("F1Hertz","F2Hertz")) +
  scale_fill_manual(values = vowelcolor)
  #+ggtitle("formant values in two vowels between groups in each test block, with masking noise")
  
ggsave("ridgeF2Block*BB_block2.png", plot = last_plot(), device = NULL, scale = 1,dpi = 600)
```

### ridge plots for RQ3

```{r}
#AF

#reshaping data
library(tidyr)
ridgedfaf <- df |> filter(block == "4", AF == "AF") |> 
  pivot_longer(
    cols = c("F1Hz","F2Hz"), 
    names_to = "formant", 
    values_to = "Hertz",
  )
head(ridgedfaf)

ggplot(ridgedfaf, aes(x = Hertz, y = formant, fill = BB)) +
  geom_density_ridges(alpha = 0.6) +
  theme_ridges() +
  scale_fill_discrete(breaks = c ("F1Hertz","F2Hertz")) +
  scale_fill_manual(values = vowelcolor)+
  ggtitle("formant values at block 4, for AF group")
ggsave("ridgeBlock4AF.png", plot = last_plot(), device = NULL, scale = 1,dpi = 600)

#MN
#reshaping data
library(tidyr)
ridgedfaf <- df |> filter(block == "4", AF == "MN") |> 
  pivot_longer(
    cols = c("F1Hz","F2Hz"), 
    names_to = "formant", 
    values_to = "Hertz",
  )
head(ridgedfaf)

ggplot(ridgedfaf, aes(x = Hertz, y = formant, fill = BB)) +
  geom_density_ridges(alpha = 0.6) +
  theme_ridges() +
  scale_fill_discrete(breaks = c ("F1Hertz","F2Hertz")) +
  scale_fill_manual(values = vowelcolor)+
  ggtitle("formant values at block 4, for MN group")
ggsave("ridgeBlock4MN.png", plot = last_plot(), device = NULL, scale = 1,dpi = 600)
```
```
```












```{r}
#reshaping data
library(tidyr)
ridgedf <- df |> filter(block == "2", AF == "AF") |> 
  pivot_longer(
    cols = c("F1Bark","F2Bark"), 
    names_to = "formant", 
    values_to = "Bark",
  )
head(ridgedf)

library(ggplot2)
library(ggridges)
#define color-blindness-friendly colors
color <- c("#0072B2", "#CC79A7")
ggplot(ridgedf, aes(x = Bark, y = formant, fill = BB)) +
  geom_density_ridges(alpha = 0.6) +
  theme_ridges() +
  scale_fill_discrete(breaks = c ("F1Bark","F2Bark")) +
  scale_fill_manual(values = color)+
  ggtitle("formant values at block 2, for AF condition")
#ggsave("ridgeBlock2AFBark.png", plot = last_plot(), device = NULL, scale = 1,dpi = 600)
```

```{r}
#reshaping data
library(tidyr)
ridgedf <- df |> filter(block == "2", AF == "MN") |> 
  pivot_longer(
    cols = c("F1Hz","F2Hz"), 
    names_to = "formant", 
    values_to = "Hertz",
  )
head(ridgedf)

library(ggplot2)
library(ggridges)
#define color-blindness-friendly colors
color <- c("#0072B2", "#CC79A7")
ggplot(ridgedf, aes(x = Hertz, y = formant, fill = BB)) +
  geom_density_ridges(alpha = 0.6) +
  theme_ridges() +
  scale_fill_discrete(breaks = c ("F1Hz","F2Hz")) +
  scale_fill_manual(values = color)+
ggtitle("formant values at block 2, for MN condition")
#ggsave("ridgeBlock2MN.png", plot = last_plot(), device = NULL, scale = 1,dpi = 600)
```


```{r}
#reshaping data
library(tidyr)
ridge4af <- df |> filter(block == "4", AF == "AF") |> 
  pivot_longer(
    cols = c("F1Hz","F2Hz"), 
    names_to = "formant", 
    values_to = "Hertz",
  )
head(ridgedf)

library(ggplot2)
library(ggridges)
#define color-blindness-friendly colors
color <- c("#0072B2", "#CC79A7")
ggplot(ridge4af, aes(x = Hertz, y = formant, fill = BB)) +
  geom_density_ridges(alpha = 0.6) +
  theme_ridges() +
  scale_fill_discrete(breaks = c ("F1Hz","F2Hz")) +
  ggtitle("formant values at block 4, for AF condition")
  scale_fill_manual(values = color)
#ggsave("ridgeBlock4AF.png", plot = last_plot(), device = NULL, scale = 1,dpi = 600)
```

```{r}
#in bark
library(tidyr)
ridge4af <- df |> filter(block == "4", AF == "AF") |> 
  pivot_longer(
    cols = c("F1Bark","F2Bark"), 
    names_to = "formant", 
    values_to = "Bark",
  )
head(ridgedf)

library(ggplot2)
library(ggridges)
#define color-blindness-friendly colors
color <- c("#0072B2", "#CC79A7")
ggplot(ridge4af, aes(x = Bark, y = formant, fill = BB)) +
  geom_density_ridges(alpha = 0.6) +
  theme_ridges() +
  scale_fill_discrete(breaks = c ("F1Bark","F2Bark")) +
  ggtitle("formant values at block 4, for AF condition")
  scale_fill_manual(values = color)
```



```{r}
#reshaping data
library(tidyr)
ridge4mn <- df |> filter(block == "4", AF == "MN") |> 
  pivot_longer(
    cols = c("F1Hz","F2Hz"), 
    names_to = "formant", 
    values_to = "Hertz",
  )
head(ridgedf)

library(ggplot2)
library(ggridges)
#define color-blindness-friendly colors
color <- c("#0072B2", "#CC79A7")
ggplot(ridge4mn, aes(x = Hertz, y = formant, fill = BB)) +
  geom_density_ridges(alpha = 0.6) +
  theme_ridges() +
  scale_fill_discrete(breaks = c ("F1Hz","F2Hz")) +
  ggtitle("formant values at block 4, for MN condition")
  scale_fill_manual(values = color)
#ggsave("ridgeBlock4MN.png", plot = last_plot(), device = NULL, scale = 1,dpi = 600)
```

```{r}
#reshaping data
library(tidyr)
ridge4mn <- df |> filter(block == "4", AF == "MN") |> 
  pivot_longer(
    cols = c("F1Bark","F2Bark"), 
    names_to = "formant", 
    values_to = "Bark",
  )
head(ridgedf)

library(ggplot2)
library(ggridges)
#define color-blindness-friendly colors
color <- c("#0072B2", "#CC79A7")
ggplot(ridge4mn, aes(x = Bark, y = formant, fill = BB)) +
  geom_density_ridges(alpha = 0.6) +
  theme_ridges() +
  scale_fill_discrete(breaks = c ("F1Bark","F2Bark")) +
  ggtitle("formant values at block 4, for MN condition")
  scale_fill_manual(values = color)
```




### ====== old version below ===== 
```{r}
#filter for the pre and post conditions
prepost <- db |> filter(block == "Pre" | block == "Post")

f1hzprepost <- lmer(F1Hz ~ block * BB * block* Label + gender + (1|subj) + (1|word), data = prepost)
summary(f1hzprepost)

f2hzprepost <- lmer(F2Hz ~ block * BB * block* Label + gender + (1|subj) + (1|word), data = prepost)
summary(f2hzprepost)
```

```{r}
#filter for MN1 and AF1, comprare with pretest
bl1 <- db |> filter(block == "Pre" | block == "MN1" | block == "AF1") 
af1subj <- c("2", "3", "5", "6", "8", "9", "10", "12", "15", "17", "19", "26", "30", "31", "33", "35", "38", "40", "42", "43", "46", "48", "50", "51", "52", "53", "54", "56", "58", "60")
bl1af <- bl1 |> mutate(
    AF = case_when(
      subj %in% af1subj ~ "AF",
      TRUE ~ "MN")) |> mutate(
     block = case_when(
      block == "AF1" ~ "2",
      block == "MN1" ~ "2",
      block == "Pre" ~ "1")
   )
      
  


#repeating contrast coding so as to not change results when rerunning this block after running the next block

#contrast coding
bl1af$BB <- as.factor(bl1af$BB)
bl1af$BB <- relevel(bl1af$BB, ref = "NB")

bl1af$Label <- as.factor(bl1af$Label)
bl1af$Label <- relevel(bl1af$Label, ref = "I")

bl1af$block <- as.factor(bl1af$block)
bl1af$block <- relevel(bl1af$block, ref = "1")

bl1af$gender <- as.factor(bl1af$gender)
bl1af$gender <- relevel(bl1af$gender, ref = "F")

f1hzbl1af <- lmer(F1Hz ~ block * BB * AF* Label + gender + (1|subj) + (1|word), data = bl1af)
summary(f1hzbl1af)

f2hzbl1af <- lmer(F2Hz ~ block * BB * AF* Label + gender + (1|subj) + (1|word), data = bl1af)
summary(f2hzbl1af)


dbaf<-  db|> filter(block == "AF1" | block == "Pre") |> filter(Label == "E")

ggplot(data = dbaf, aes(x = F2Hz, y = F1Hz, color = block))+
  geom_point(alpha = 0.5)
```
Interpretation:
F1 model:

#### blockMN1               53.658      9.036   5.938

MN group has 53.758Hz higher F1 at test compared to pretest (whereas AF group did not show difference) -> Lombard?

#### LabelE                167.017     10.450  15.983

/E/ is 167.017Hz higher in F1 than /I/(at pretest).

#### genderM               -98.731     23.301  -4.237

Male speakers' F1 is 98.731Hz lower than female speakers (at pretest)

#### blockAF1:BBBB          31.336     12.370   2.533

The F1 difference between NB and BB group is 31Hz bigger at AF1 than at pretest (note that at pretest the BB group did not have the bite block in)

#### blockMN1:LabelE        47.236     11.855   3.985 

The F1 difference between /E/ and /I/ is bigger at MN1 than at pretest (auditory feedback at pretest is AF)

#### BBBB:LabelE           -33.046      9.517  -3.472

The F1 difference between /E/ and /I/ is smaller in the BB group than in the NB group at pretest

#### blockMN1:BBBB:LabelE  -49.059     16.768  -2.926

?


```{r}
#splitting up MN1 and AF1, compare with pretest respectively
af <- db |> filter(block == "Pre" | block == "AF1")
mn <- db |> filter(block == "Pre" | block == "MN1")

#contrast coding
af$BB <- as.factor(af$BB)
af$BB <- relevel(af$BB, ref = "NB")

af$Label <- as.factor(af$Label)
af$Label <- relevel(af$Label, ref = "I")

af$block <- as.factor(af$block)
af$block <- relevel(af$block, ref = "Pre")

af$gender <- as.factor(af$gender)
af$gender <- relevel(af$gender, ref = "F")

f1hzaf <- lmer(F1Hz ~ block * BB * Label + gender + (1|subj) + (1|word), data = af)
summary(f1hzaf)

mn$BB <- as.factor(mn$BB)
mn$BB <- relevel(mn$BB, ref = "NB")

mn$Label <- as.factor(mn$Label)
mn$Label <- relevel(mn$Label, ref = "I")

mn$block <- as.factor(mn$block)
mn$block <- relevel(mn$block, ref = "Pre")

mn$gender <- as.factor(mn$gender)
mn$gender <- relevel(mn$gender, ref = "F")

f1hzmn <- lmer(F1Hz ~ block * BB * block* Label + gender + (1|subj) + (1|word), data = mn)
summary(f1hzmn)
```

Interpretation: 

**AF model:**

#### blockAF1               10.329      7.846   1.316

in NB group, the F1 (of female speakers) in the AF test condition did not differ from pretest

#### BBBB                    5.255     16.573   0.317

The F1 in /I/ in BB group at pretest does not differ from NB group among female speakers

#### LabelE                167.312     13.098  12.774

the F1 in /E/ is 167.312 Hz higher than /I/ in the females speakers in the NB group at pretest

#### genderM               -93.417     21.272  -4.392

Male speakers in the NB group have an F1 that is 93.417Hz lower than the female speakers in the NB group at pretest

#### blockAF1:BBBB          31.225     10.767   2.900

The increase of F1 from pretest to AF1 is 31.225 Hz bigger in the BB group (for female speakers). Since BB group did not differ from NB group at pretest, **we can conclude that having a bite block increased the F1 of 31.225 Hz in the AF1 block for female speakers**.

#### blockAF1:LabelE       -27.850     10.317  -2.699

The increase of F1 from /I/ to /E/ is 27.850 Hz smaller in the AF (and no bite block, female) group at test block compared to pretest; i.e., the /I/ -/E/ contrast is 27.850 Hz smaller in the AF group at test --> practice effect? 

#### BBBB:LabelE           -33.366      8.280  -4.030

At pretest, the increase of F1 from /I/ to /E/ is 33. 366 Hz smaller in the BB group than the NB group. BB group behaves differently at pretest again. But since the F1 in /I/ did not differ between BB and NB group (see result BBBB where t = 0.317), it's mainly the /E/ that differed between NB and BB group at pretest.

**MN model:**

#### blockMN1               53.786      9.226   5.830

For female speakers in the NB group, being in the MN condition increased (from pretest) the F1 of /I/ for 53.786 Hz -> Lombard

#### BBBB                    4.803     17.433   0.276

For female speakers at pretest, the F1 in /I/ does not differ between NB and BB group

#### LabelE                167.281     11.276  14.835

For female speakers in the NB group, at pretest, the F1 in /E/ is 167.281 Hz higher than /I/

#### genderM               -93.159     22.364  -4.166

At pretest, in the NB group, for vowel /I/, male speakers have an F1 that is 93.159 Hz lower than the female speakers in the same group at the same stage of testing.

#### blockMN1:BBBB          16.890     13.076   1.292

The increase of F1 from pretest to MN1 (females, vowel /I/) does not differ between BB and NB groups.

#### blockMN1:LabelE        47.002     12.114   3.880 

The increase of F1 from /I/ to /E/ from pretest to MN1 (i.e., the F1 difference between /I/ and /E/ from pretest to MN) is 47.002 Hz bigger --> hyperarticulation in Lombard?

#### blockMN1:BBBB:LabelE  -49.074     17.135  -2.864

The difference between /I/ and /E/ between BB and NB group (the difference of the size of the /I/- /E/ contrast between BB and NB group) is -49.074 Hz at MN1 when compared to pretest. That the BB group has a 49.074 Hz smaller /I/ -/E/ contrast change (pretest to MN1) than the NB group.

```{r}
#code male as reference level to check whether the BB group have a different F1 at AF1
# (the alternative would be to code the contrast for gender as -0.5/+0.5, which then has the mean of F and M as the reference level. But literature has shown a gender difference in tongue root mobility, so we have reason to distinguish the two)
af$gender <- as.factor(af$gender)
af$gender <- relevel(af$gender, ref = "M")

mn$gender <- as.factor(mn$gender)
mn$gender <- relevel(mn$gender, ref = "M")

f1hzafm <- lmer(F1Hz ~ block * BB * block* Label + gender + (1|subj) + (1|word), data = af)
summary(f1hzafm)

f1hzmnm <- lmer(F1Hz ~ block * BB * block* Label + gender + (1|subj) + (1|word), data = mn)
summary(f1hzmnm)

```

same results except intercept.

```{r}
#model plot
data_summary <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,
                  varname)
  data_sum <- rename(data_sum, c("mean" = varname))
 return(data_sum)
}


library(ggplot2)
f1i <- af |> filter(Label == "I")

f1e <- af |> filter(Label == "E")

f1ierr <- data_summary(f1i, varname="F1Hz", 
                    groupnames=c("block", "BB"))

f1eerr <- data_summary(f1e, varname="F1Hz", 
                    groupnames=c("block", "BB"))


p1<- ggplot(data=f1i, aes(x=BB, y=F1Hz, fill=block)) +
  geom_bar(stat="identity", position=position_dodge())+
  labs (title = "F1 of /I/ at pre test and test, in AF condition")

p1 + geom_errorbar(data = f1ierr, aes(ymin=F1Hz-sd, ymax=F1Hz+sd), width=.2,
                 position=position_dodge(.9))



p2 <- ggplot(data=f1e, aes(x=BB, y=F1Hz, fill=block)) +
  geom_bar(stat="identity", position=position_dodge())+
  labs (title = "F1 of /E/ at pre test and test, in AF condition")

p2 + geom_errorbar(data = f1eerr, aes(ymin=F1Hz-sd, ymax=F1Hz+sd), width=.2,
                 position=position_dodge(.9))

```
```{r}
#model plot
library(ggplot2)
mni <- mn |> filter(Label == "I")

ggplot(data=mni, aes(x=BB, y=F1Hz, fill=block)) +
  geom_bar(stat="identity", position=position_dodge())+
  labs (title = "F1 of /I/ at pre test and test, in MN condition")

mne <- mn |> filter(Label == "E")

ggplot(data=mne, aes(x=BB, y=F1Hz, fill=block)) +
  geom_bar(stat="identity", position=position_dodge())+
  labs (title = "F1 of /E/ at pre test and test, in MN condition")
```

```{r}
#add in error bars
data_summary <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,
                  varname)
  data_sum <- rename(data_sum, c("mean" = varname))
 return(data_sum)
}


f1ierr <- data_summary(f1i, varname="F1Hz", 
                    groupnames=c("block", "BB"))

f1eerr <- data_summary(f1e, varname="F1Hz", 
                    groupnames=c("block", "BB"))

head(f1ierr)

p <- ggplot(data=f1ierr, aes(x=BB, y=F1Hz, fill=block)) + 
   geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=F1Hz-sd, ymax=F1Hz+sd), width=.2,
                 position=position_dodge(.9))
  
p + scale_fill_brewer(palette="Paired") + theme_minimal()+labs (title = "F1 of /I/ at pre test and test, in AF condition")
```

```{r}
library(effects)

plot(effect( "block * BB * Label", f1hzmn))

plot(effect( "block * BB * Label", f1hzaf))
```

```{r}
#f2 models
af$gender <- as.factor(af$gender)
af$gender <- relevel(af$gender, ref = "F")
f2hzaf <- lmer(F2Hz ~ block * BB * block* Label + gender + (1|subj) + (1|word), data = af)
summary(f2hzaf)

f2hzmn <- lmer(F2Hz ~ block * BB * block* Label + gender + (1|subj) + (1|word), data = mn)
summary(f2hzmn)
```

```{r}
plot(effect( "block * BB * Label", f1hzaf))
```

```{r}
#prepost model
#splitting up MN1 and AF1, compare with pretest respectively
prepost <- db |> filter(block == "Pre" | block == "Post")

#contrast coding
prepost$BB <- as.factor(prepost$BB)
prepost$BB <- relevel(prepost$BB, ref = "NB")

prepost$Label <- as.factor(prepost$Label)
prepost$Label <- relevel(prepost$Label, ref = "I")

prepost$block <- as.factor(prepost$block)
prepost$block <- relevel(prepost$block, ref = "Pre")

prepost$gender <- as.factor(prepost$gender)
prepost$gender <- relevel(prepost$gender, ref = "F")

f1hzpp <- lmer(F1Hz ~ block * BB * Label + gender + (1|subj) + (1|word), data = prepost)
summary(f1hzpp)

f2hzpp <- lmer(F2Hz ~ block * BB * Label + gender + (1|subj) + (1|word), data = prepost)
summary(f2hzpp)
```

```{r}
#plotting the one significant result
plot(effect( "BB * Label", f1hzpp))
```

```{r}
mn2subj <- c("2", "3", "5", "6", "8", "9", "10", "12", "15", "17", "19", "26", "30", "31", "33", "35", "38", "40", "42", "43", "46", "48", "50", "51", "52", "53", "54", "56", "58", "60")
ppaf <- db |> filter(subj %in% mn2subj)|> filter(block == "Pre" | block == "Post")

ppmn <- db |> filter(!subj %in% mn2subj)|> filter(block == "Pre" | block == "Post")


#change df name
ppaf$BB <- as.factor(ppaf$BB)
ppaf$BB <- relevel(ppaf$BB, ref = "NB")

ppaf$Label <- as.factor(ppaf$Label)
ppaf$Label <- relevel(ppaf$Label, ref = "I")

ppaf$block <- as.factor(ppaf$block)
ppaf$block <- relevel(ppaf$block, ref = "Pre")

ppaf$gender <- as.factor(ppaf$gender)
ppaf$gender <- relevel(ppaf$gender, ref = "F")

ppmn$BB <- as.factor(ppmn$BB)
ppmn$BB <- relevel(ppmn$BB, ref = "NB")

ppmn$Label <- as.factor(ppmn$Label)
ppmn$Label <- relevel(ppmn$Label, ref = "I")

ppmn$block <- as.factor(ppmn$block)
ppmn$block <- relevel(ppmn$block, ref = "Pre")

ppmn$gender <- as.factor(ppmn$gender)
ppmn$gender <- relevel(ppmn$gender, ref = "F")

#run lmers 

ppmnf1 <- lmer(F1Hz ~ block * BB * Label + gender + (1|subj) + (1|word), data = ppmn)
summary(ppmnf1)

ppmnf2 <- lmer(F2Hz ~ block * BB * Label + gender + (1|subj) + (1|word), data = ppmn)
summary(ppmnf2)

ppaff1 <- lmer(F1Hz ~ block * BB * Label + gender + (1|subj) + (1|word), data = ppaf)
summary(ppaff1)

ppaff2 <- lmer(F2Hz ~ block * BB * Label + gender + (1|subj) + (1|word), data = ppaf)
summary(ppaff2)
```

